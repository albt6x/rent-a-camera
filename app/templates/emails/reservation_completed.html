<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <title>Reservasi Telah Selesai</title>
</head>

<body style="margin:0; padding:0; background-color:#f4f6f8; font-family:Arial, sans-serif;">

  <table width="100%" cellpadding="0" cellspacing="0" bgcolor="#f4f6f8">
    <tr>
      <td align="center" style="padding:24px 12px;">

        <table width="100%" cellpadding="0" cellspacing="0"
               style="max-width:680px; background-color:#ffffff; border-radius:8px;">

          <tr>
            <td style="padding:20px 28px; background-color:#2b6ef6; color:#ffffff;">
              <h1 style="margin:0; font-size:20px; font-weight:600;">
                Reservasi Telah Selesai — Rentalkuy
              </h1>
            </td>
          </tr>

          <tr>
            <td style="padding:22px 28px; font-size:14px; color:#1f2937; line-height:1.5;">

              {# Tentukan nama tampilan #}
              {% set _person = (borrower if (borrower is defined and borrower)
                                else (buyer if (buyer is defined and buyer) else None)) %}
              {% if _person %}
                {% if _person.username %}
                  {% set _display_name = _person.username %}
                {% elif _person.email %}
                  {% set _display_name = _person.email %}
                {% else %}
                  {% set _display_name = 'Pengguna' %}
                {% endif %}
              {% else %}
                {% set _display_name = 'Pengguna' %}
              {% endif %}

              <p style="margin:0 0 10px 0;">
                Halo <strong>{{ _display_name }}</strong>,
              </p>

              <p style="margin:0 0 14px 0; color:#6b7280;">
                Reservasi Anda telah <strong>selesai</strong> dan barang sudah diterima kembali.
                Berikut ringkasan pesanan Anda.
              </p>

              <table width="100%" cellpadding="0" cellspacing="0"
                     bgcolor="#f8fafc"
                     style="border-radius:6px; margin-bottom:16px;">
                <tr>
                  <td style="padding:14px; font-size:13px; color:#374151;">

                    <p style="margin:0 0 6px 0;">
                      <strong>Order ID:</strong>
                      {# LOGIC UPDATE: Konsisten RK-XXXX atau #ID #}
                      {%- if rental is defined and rental -%}
                        {{ rental.public_id if rental.public_id else "#" ~ rental.id }}
                      {%- elif public_id is defined and public_id -%}
                        {{ public_id }}
                      {%- elif id is defined and id -%}
                        #{{ id }}
                      {%- else -%}
                        —
                      {%- endif -%}
                    </p>

                    <p style="margin:0 0 6px 0;">
                      <strong>Tanggal Pengembalian:</strong>
                      {%- if rental is defined and rental -%}
                        {%- if rental.returned_at is defined and rental.returned_at -%}
                          {{ rental.returned_at }}
                        {%- elif rental.completed_at is defined and rental.completed_at -%}
                          {{ rental.completed_at }}
                        {%- elif rental.updated_at is defined and rental.updated_at -%}
                          {{ rental.updated_at }}
                        {%- elif rental.created_at is defined and rental.created_at -%}
                          {{ rental.created_at }}
                        {%- else -%}
                          —
                        {%- endif -%}
                      {%- else -%}
                        {%- if returned_at is defined and returned_at -%}
                          {{ returned_at }}
                        {%- elif completed_at is defined and completed_at -%}
                          {{ completed_at }}
                        {%- elif updated_at is defined and updated_at -%}
                          {{ updated_at }}
                        {%- elif created_at is defined and created_at -%}
                          {{ created_at }}
                        {%- else -%}
                          —
                        {%- endif -%}
                      {%- endif -%}
                    </p>

                    <p style="margin:0;">
                      <strong>Status Akhir:</strong> Selesai
                    </p>

                  </td>
                </tr>
              </table>

              <h3 style="margin:0 0 8px 0; font-size:15px;">
                Detail Item
              </h3>

              <table width="100%" cellpadding="0" cellspacing="0">
                {% if rental is defined and rental and rental.items %}
                  {% for ri in rental.items %}
                    <tr>
                      <td style="padding:10px 12px; border:1px solid #eef2f7; border-radius:6px;">

                        <table width="100%" cellpadding="0" cellspacing="0">
                          <tr>
                            <td style="font-size:14px; color:#111827;">
                              {% if ri and ri.item and ri.item.name %}
                                {{ ri.item.name }}
                              {% else %}
                                Item
                              {% endif %}
                              {% if ri.duration_hours %}
                                <br>
                                <span style="font-size:12px; color:#6b7280;">
                                  Durasi: {{ ri.duration_hours }} jam
                                </span>
                              {% endif %}
                            </td>
                            <td align="right" style="font-size:13px; color:#6b7280;">
                              {% set price_val = (ri.price_at_checkout
                                  if (ri.price_at_checkout is defined and ri.price_at_checkout is not none)
                                  else (ri.price if (ri.price is defined) else None)) %}
                              {% if price_val is not none %}
                                Rp {{ "{:,.0f}".format(price_val|float) | replace(',', '.') }}
                              {% else %}
                                Rp —
                              {% endif %}
                            </td>
                          </tr>
                        </table>

                      </td>
                    </tr>
                    <tr><td height="8"></td></tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td style="font-size:13px; color:#6b7280;">
                      Tidak ada item tercatat pada reservasi ini.
                    </td>
                  </tr>
                {% endif %}
              </table>

              <p style="margin:14px 0 18px 0; font-weight:600;">
                Total:
                {% if rental is defined and rental and rental.total_price is not none %}
                  Rp {{ "{:,.0f}".format(rental.total_price|float) | replace(',', '.') }}
                {% elif total_price is defined and total_price is not none %}
                  Rp {{ "{:,.0f}".format(total_price|float) | replace(',', '.') }}
                {% else %}
                  Rp —
                {% endif %}
              </p>

              {% if dashboard_url is defined and dashboard_url %}
                <a href="{{ dashboard_url }}"
                   style="display:inline-block; padding:10px 16px; background-color:#2563eb; color:#ffffff; text-decoration:none; border-radius:6px; font-weight:600;">
                  Cek Dashboard
                </a>
              {% elif url_root is defined and url_root %}
                <a href="{{ (url_root|string).rstrip('/') }}/account/dashboard"
                   style="display:inline-block; padding:10px 16px; background-color:#2563eb; color:#ffffff; text-decoration:none; border-radius:6px; font-weight:600;">
                  Cek Dashboard
                </a>
              {% else %}
                <p style="margin:0; font-size:13px; color:#6b7280;">
                  Masuk ke dashboard untuk melihat detail reservasi.
                </p>
              {% endif %}

              <p style="margin:12px 0 0 0; font-size:13px; color:#6b7280;">
                Jika ada kendala, balas email ini atau hubungi admin.
                Terima kasih telah menggunakan Rentalkuy!
              </p>

            </td>
          </tr>

          <tr>
            <td style="padding:18px 28px; font-size:12px; color:#6b7280; text-align:center; background-color:#fcfdff;">
              {{ mail_footer if (mail_footer is defined and mail_footer)
                 else "Rentalkuy · Jl. Contoh No.1 · 0896-7833-XXXX" }}
            </td>
          </tr>

        </table>

      </td>
    </tr>
  </table>

</body>
</html>