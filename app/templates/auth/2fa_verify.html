{% extends "layouts/base.html" %}

{% block content %}
<div class="container mt-5" style="max-width: 460px;">
  <div class="card shadow-sm">
    <div class="card-body">

      <h4 class="text-center mb-3">Verifikasi Keamanan (2FA)</h4>

      <p class="text-muted text-center mb-4">
        Masukkan <strong>kode 6 digit</strong> dari aplikasi Authenticator Anda
        untuk melanjutkan login sebagai admin.
      </p>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} text-center">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- FORM QR AUTHENTICATOR -->
      <form method="POST" action="{{ url_for('auth.twofa_verify') }}">
        {{ csrf_token() }}

        <div class="mb-3">
          <label for="code" class="form-label">Kode Authenticator</label>
          <input
            type="tel"
            inputmode="numeric"
            pattern="\d{6}"
            maxlength="6"
            class="form-control text-center fs-5"
            id="code"
            name="code"
            placeholder="123456"
            required
            autofocus
            autocomplete="one-time-code"
          >
        </div>

        <button type="submit" class="btn btn-primary w-100">
          Verifikasi & Masuk
        </button>
      </form>

      <!-- FALLBACK LINK -->
      <div class="text-center mt-3">
        <a
          href="#"
          class="small text-decoration-none"
          data-bs-toggle="collapse"
          data-bs-target="#fallbackBox"
          aria-expanded="false"
        >
          Tidak bisa pakai Authenticator?
        </a>
      </div>

      <!-- FALLBACK BOX -->
      <div class="collapse mt-3" id="fallbackBox">
        <div class="alert alert-warning small">
          <strong>Mode Darurat:</strong><br>
          Kami akan mengirimkan kode verifikasi ke email admin Anda.
          Metode ini <strong>hanya untuk keadaan darurat</strong> dan
          setelah berhasil Anda akan diminta <strong>setup ulang QR 2FA</strong>.
        </div>

        <div class="d-grid gap-2">
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            onclick="requestEmailFallback()"
          >
            Kirim Kode ke Email
          </button>
        </div>

        <div id="emailFallbackStatus" class="text-muted small mt-2 text-center"></div>

        <form
          method="POST"
          action="{{ url_for('twofa.twofa_fallback_verify') }}"
          class="mt-3"
        >
          {{ csrf_token() }}

          <div class="mb-2">
            <input
              type="tel"
              inputmode="numeric"
              pattern="\d{6}"
              maxlength="6"
              class="form-control text-center"
              name="code"
              placeholder="Kode dari Email"
            >
          </div>

          <button type="submit" class="btn btn-warning btn-sm w-100">
            Verifikasi via Email
          </button>
        </form>
      </div>

      <!-- FOOTER -->
      <div class="text-center mt-4">
        <small class="text-muted">
          Demi keamanan akun admin, 2FA wajib diaktifkan.
        </small>
      </div>

      <div class="text-center mt-2">
        <a href="{{ url_for('auth.login') }}" class="small">
          ← Kembali ke Login
        </a>
      </div>

    </div>
  </div>
</div>

<script>
function requestEmailFallback() {
  const status = document.getElementById("emailFallbackStatus");
  status.innerText = "Mengirim kode ke email…";

  fetch("{{ url_for('twofa.twofa_fallback_request') }}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token() }}"
    }
  })
  .then(r => r.json())
  .then(data => {
    if (data.ok) {
      status.innerText = "Kode berhasil dikirim. Periksa email Anda.";
    } else {
      status.innerText = "Gagal mengirim kode. Coba lagi.";
    }
  })
  .catch(() => {
    status.innerText = "Terjadi kesalahan. Coba beberapa saat lagi.";
  });
}
</script>
{% endblock %}
