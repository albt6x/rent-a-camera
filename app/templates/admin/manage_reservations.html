{# templates/admin/manage_reservations.html (FULL REPLACE - STAFF NO PROOF) #}
{% extends "base.html" %}

{% block title %}Manajemen Reservasi{% endblock %}

{% block content %}

{# --- VARIABLE SETUP --- #}
{% set base_endpoint = 'staff.dashboard' if is_staff_dashboard else 'admin.manage_reservations' %}

<div class="admin-sidebar">
  {% include 'admin/admin_menu.html' %}
</div>

<main class="admin-content">
  {% include 'flash_messages.html' %}

  <div class="card mb-4 shadow-sm border-0">
    <div class="card-body">
      <div class="row g-3 align-items-center">
          <div class="col-md-6">
              <h2 class="mb-1 fw-bold">Manajemen Reservasi</h2>
              <p class="text-muted mb-0">Kelola persetujuan dan status pesanan masuk.</p>
          </div>
          
          <div class="col-md-6">
            <div class="d-flex gap-2 justify-content-md-end">
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" id="searchInput" class="form-control border-start-0 ps-0" placeholder="Cari Nama / ID Order...">
                </div>
            </div>
          </div>
      </div>

      {% if not is_staff_dashboard %}
      <div class="mt-3">
          <div class="btn-group shadow-sm" role="group">
            <a href="{{ url_for(base_endpoint) }}" class="btn btn-sm btn-outline-dark {% if not status_filter %}active{% endif %}">Semua</a>
            <a href="{{ url_for(base_endpoint, status='Ditinjau') }}" class="btn btn-sm btn-outline-warning text-dark {% if status_filter == 'Ditinjau' %}active{% endif %}">Baru</a>
            <a href="{{ url_for(base_endpoint, status='ACC') }}" class="btn btn-sm btn-outline-success {% if status_filter == 'ACC' %}active{% endif %}">Aktif</a>
            <a href="{{ url_for(base_endpoint, status='Selesai') }}" class="btn btn-sm btn-outline-secondary {% if status_filter == 'Selesai' %}active{% endif %}">Selesai</a>
          </div>
      </div>
      {% endif %}

    </div>
  </div>

  <div class="card shadow-sm border-0 rounded-3 overflow-hidden">
    <div class="card-body p-0">
      <div class="table-responsive">
        
        <table class="table table-hover mb-0 align-middle" id="rentalTable" style="table-layout: fixed; min-width: 1000px;">
          <thead class="bg-light text-secondary border-bottom">
            <tr>
              <th style="width: 15%;" class="ps-4">ID Order</th>
              <th style="width: 25%;">Pelanggan</th>
              <th style="width: 20%;">Info Sewa</th>
              <th style="width: 15%;">Status</th>
              <th style="width: 25%;" class="text-end pe-4">Aksi</th>
            </tr>
          </thead>
          <tbody>

          {% if rentals and rentals.items %}
            {% for rental in rentals.items %}
            <tr class="rental-row">
              <td class="ps-4 align-top py-3">
                 <span class="badge bg-light text-dark border font-monospace mb-1 searchable">
                    {{ rental.public_id if rental.public_id else "#" ~ rental.id }}
                 </span>
                 <br>
                 <small class="text-muted" style="font-size: 0.75rem;">
                   {{ rental.created_at.strftime('%d/%m %H:%M') }}
                 </small>
              </td>

              <td class="align-top py-3">
                <div class="d-flex">
                  {% if rental.borrower and rental.borrower.image_file %}
                    <img src="{{ url_for('static', filename='uploads/profile_pics/' ~ rental.borrower.image_file) }}"
                         width="40" height="40" class="rounded-circle border me-3" style="object-fit:cover;">
                  {% else %}
                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3" style="width:40px; height:40px;">
                        <i class="bi bi-person-fill fs-5"></i>
                    </div>
                  {% endif %}
                  <div style="overflow: hidden;">
                      <h6 class="mb-0 fw-bold text-truncate text-dark searchable">{{ rental.borrower.username }}</h6>
                      
                      <div class="d-flex align-items-center gap-2">
                          <small class="text-muted text-truncate">{{ rental.borrower.email }}</small>
                          
                          <a href="https://wa.me/6281234567890?text=Halo%20{{ rental.borrower.username }},%20terkait%20order%20{{ rental.public_id }}..." 
                             target="_blank" 
                             class="text-success text-decoration-none" 
                             title="Chat WhatsApp">
                              <i class="fab fa-whatsapp"></i>
                          </a>
                      </div>
                  </div>
                </div>
              </td>

              <td class="align-top py-3">
                <div class="mb-1">
                    <i class="bi bi-calendar-event me-1 text-secondary"></i> 
                    <span class="fw-medium">{{ rental.pickup_date.strftime('%d %b %Y') if rental.pickup_date else '-' }}</span>
                </div>
                <div class="mb-1">
                    <span class="fw-bold text-primary">Rp {{ "{:,.0f}".format(rental.total_price) }}</span>
                </div>

                {# --- LOGIC BARU: HANYA TAMPIL JIKA USER ADALAH ADMIN --- #}
                {% if rental.payment_proof and current_user.role == 'admin' %}
                  <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none view-proof-btn"
                          data-bs-toggle="modal" data-bs-target="#proofModal"
                          data-img="{{ url_for('static', filename='uploads/payment_proofs/' ~ rental.payment_proof) }}"
                          data-title="Bukti - {{ rental.public_id }}">
                    <small><i class="fas fa-paperclip"></i> Lihat Bukti Bayar</small>
                  </button>
                {% endif %}
                {# ----------------------------------------------------- #}
              </td>

              <td class="align-top py-3">
                <div class="mb-1">
                    {% if rental.order_status == 'Ditinjau' %}
                        <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Review</span>
                    {% elif rental.order_status == 'ACC' %}
                        <span class="badge bg-success"><i class="fas fa-check me-1"></i>ACC</span>
                    {% elif rental.order_status == 'Ditolak' %}
                        <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Ditolak</span>
                    {% endif %}
                </div>
                <div>
                    {% if rental.payment_status == 'Belum Bayar' %}
                        <span class="badge bg-light text-secondary border">Belum Bayar</span>
                    {% elif rental.payment_status == 'Menunggu Konfirmasi' %}
                        <span class="badge bg-info text-dark">Cek Transfer</span>
                    {% elif rental.payment_status == 'Pengambilan' %}
                        <span class="badge bg-primary">Siap Diambil</span>
                    {% elif rental.payment_status == 'Selesai' %}
                        <span class="badge bg-secondary">Selesai</span>
                    {% endif %}
                </div>
              </td>

              <td class="text-end pe-4 align-top py-3">
                <div class="d-flex justify-content-end gap-2">
                    
                    <button type="button" class="btn btn-sm btn-light border" 
                            data-bs-toggle="modal" 
                            data-bs-target="#detailModal{{ rental.id }}"
                            title="Detail">
                        <i class="fas fa-eye text-dark"></i>
                    </button>

                    {% if rental.order_status == 'Ditinjau' %}
                      <form method="POST" action="{{ url_for('admin.approve_rental', rental_id=rental.id) }}">
                        <button class="btn btn-sm btn-success" title="Terima"><i class="fas fa-check"></i></button>
                      </form>
                      <form method="POST" action="{{ url_for('admin.reject_rental', rental_id=rental.id) }}">
                        <button class="btn btn-sm btn-danger" title="Tolak"><i class="fas fa-times"></i></button>
                      </form>

                    {% elif rental.order_status == 'ACC' %}
                      
                      {% if rental.payment_status == 'Menunggu Konfirmasi' %}
                        {# Konfirmasi Pembayaran juga sebaiknya hanya Admin, tapi jika Staff boleh konfirmasi, biarkan saja #}
                        <form method="POST" action="{{ url_for('admin.confirm_payment', rental_id=rental.id) }}">
                          <button class="btn btn-sm btn-primary" title="Validasi Pembayaran">Validasi</button>
                        </form>

                      {% elif rental.payment_status == 'Pengambilan' %}
                        <form method="POST" action="{{ url_for('admin.mark_as_returned', rental_id=rental.id) }}">
                          <button class="btn btn-sm btn-primary" title="Tandai Selesai">Selesai</button>
                        </form>

                      {% endif %}
                      
                    {% endif %}
                </div>
              </td>
            </tr>

            <div class="modal fade" id="detailModal{{ rental.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content border-0 shadow">
                        <div class="modal-header bg-light">
                            <h5 class="modal-title fw-bold">Order: {{ rental.public_id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-4">
                            <h6 class="fw-bold mb-3 text-secondary">Barang Sewaan:</h6>
                            {% for rental_item in rental.items %}
                            <div class="card mb-2 border">
                                <div class="row g-0">
                                    <div class="col-2 bg-light d-flex align-items-center justify-content-center">
                                        <img src="{{ url_for('static', filename='uploads/items/' ~ rental_item.item.image_filename) }}" 
                                             style="max-height: 50px;">
                                    </div>
                                    <div class="col-10">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between">
                                                <span class="fw-bold">{{ rental_item.item.name }}</span>
                                                <span class="fw-bold text-primary">Rp {{ "{:,.0f}".format(rental_item.price_at_checkout) }}</span>
                                            </div>
                                            <small class="text-muted">Durasi: {{ rental_item.duration_hours }} Jam</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="text-end mt-3 border-top pt-2">
                                <h5 class="fw-bold">Total: Rp {{ "{:,.0f}".format(rental.total_price) }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% endfor %}

          {% else %}
            <tr class="no-result-row"><td colspan="5" class="text-center py-5 text-muted">Belum ada data.</td></tr>
          {% endif %}
          
          <tr id="noSearchRow" style="display: none;">
              <td colspan="5" class="text-center py-4 text-muted">
                  <i class="fas fa-search fa-2x mb-3 text-secondary opacity-25"></i>
                  <p>Tidak ditemukan hasil untuk pencarian tersebut.</p>
              </td>
          </tr>

          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% if rentals and rentals.pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      <li class="page-item {% if not rentals.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for(base_endpoint, page=rentals.prev_num, status=status_filter) }}">Previous</a>
      </li>
      {% for p in range(1, rentals.pages + 1) %}
        <li class="page-item {% if p == rentals.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for(base_endpoint, page=p, status=status_filter) }}">{{ p }}</a>
        </li>
      {% endfor %}
      <li class="page-item {% if not rentals.has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ url_for(base_endpoint, page=rentals.next_num, status=status_filter) }}">Next</a>
      </li>
    </ul>
  </nav>
  {% endif %}

</main>

<div class="modal fade" id="proofModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bukti Pembayaran</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="proofModalImg" src="" style="max-width:100%; border-radius:6px;">
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // 1. LOGIC SEARCH BAR
  const searchInput = document.getElementById('searchInput');
  const tableRows = document.querySelectorAll('.rental-row');
  const noSearchRow = document.getElementById('noSearchRow');

  if(searchInput) {
      searchInput.addEventListener('keyup', function(e) {
          const term = e.target.value.toLowerCase();
          let hasResult = false;

          tableRows.forEach(row => {
              const searchText = row.innerText.toLowerCase();
              if(searchText.includes(term)) {
                  row.style.display = '';
                  hasResult = true;
              } else {
                  row.style.display = 'none';
              }
          });

          if(!hasResult && term !== '') {
              noSearchRow.style.display = '';
          } else {
              noSearchRow.style.display = 'none';
          }
      });
  }

  // 2. LOGIC MODAL BUKTI
  const modal = document.getElementById("proofModal");
  const modalImg = document.getElementById("proofModalImg");
  const modalTitle = modal ? modal.querySelector(".modal-title") : null;
  document.body.addEventListener("click", function (e) {
    const btn = e.target.closest(".view-proof-btn");
    if (!btn) return;
    if (modalImg) modalImg.src = btn.dataset.img;
    if (modalTitle) modalTitle.textContent = btn.dataset.title;
  });
  if (modal) {
    modal.addEventListener("hidden.bs.modal", () => { if (modalImg) modalImg.src = ""; });
  }
});
</script>
{% endblock %}