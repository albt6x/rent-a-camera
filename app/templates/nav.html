{# templates/nav.html - FULL REPLACE (SEARCH ICON + GRID FILTER + CART ICON) #}

<style>
  /* --- 1. Style Standar --- */
  input[type="search"]::-webkit-search-cancel-button { display: none; }
  input[type="search"]::-ms-clear { display: none; }

  .auth-link {
    padding: 0.35rem 1.1rem;
    border-radius: 999px;
    font-weight: 500;
    color: #ffffff;
    background-color: #0d6efd;
    border: 1px solid #0d6efd;
    transition: background-color 0.2s ease;
    white-space: nowrap;
    text-decoration: none;
    display: inline-block;
  }
  .auth-link:hover { background-color: #0b5ed7; color: #ffffff; }
  .nav-item-auth { margin-left: 0.5rem; }

  /* --- 2. Style Search Bar Modern (Menyatu) --- */
  .nav-search-form { 
      width: 520px; 
      max-width: 52vw; 
      position: relative; 
      display: flex;
  }
  @media (max-width: 992px) { .nav-search-form { width: 360px; max-width: 60vw; } }
  @media (max-width: 576px) { .nav-search-form { width: 100%; max-width: none; margin-top: 0.5rem; } }

  /* Input Field */
  .nav-search-form .form-control {
    border-radius: 50px 0 0 50px; /* Bulat kiri saja */
    height: 40px; 
    padding-left: 20px; 
    padding-right: 40px; /* Space untuk tombol X */
    border-right: none; /* Hilangkan garis kanan biar nyatu sama tombol */
  }
  .nav-search-form .form-control:focus {
      border-color: #ced4da;
      box-shadow: none; /* Hilangkan glow biru default biar rapi */
  }

  /* Tombol Search (Ikon) */
  .nav-search-form .btn-search { 
      height: 40px; 
      border-radius: 0 50px 50px 0; /* Bulat kanan saja */
      padding: 0 20px; 
      border: 1px solid #ced4da;
      border-left: none;
      background-color: #fff;
      color: #0d6efd;
      transition: all 0.3s;
  }
  .nav-search-form .btn-search:hover {
      background-color: #0d6efd;
      color: white;
  }

  /* Tombol Clear (X) - Posisi disesuaikan */
  .nav-clear-btn {
    position: absolute; 
    right: 60px; /* Geser agar tidak menabrak tombol search */
    top: 50%; 
    transform: translateY(-50%);
    border: none; background: transparent; color: #999; font-size: 18px;
    cursor: pointer; display: none; padding: 0 6px; line-height: 1; z-index: 10;
  }
  .nav-clear-btn:hover { color: #333; }

  .nav-search-placeholder { width: 520px; max-width: 52vw; height: 40px; }
</style>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container">
    
    <a class="navbar-brand" href="{{ url_for('main.home') }}">RentalKuy</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">

      <ul class="navbar-nav me-auto align-items-center">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('catalog.list_items') }}">Katalog</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('main.about') }}">Tentang</a></li>
      </ul>

      {# --- SEARCH BAR --- #}
      {% if not request.path.startswith('/admin') and not request.path.startswith('/staff') %}
        
        <form class="d-flex me-3 nav-search-form" method="GET" action="{{ url_for('catalog.list_items') }}" id="nav-search-form" autocomplete="off">
          
          <input class="form-control" id="nav-search-input" type="search" name="q"
                 placeholder="Cari item..." value="{{ request.args.get('q', '') }}">
          
          <button type="button" class="nav-clear-btn" id="nav-clear-btn" aria-label="Bersihkan">âœ•</button>
          
          <button class="btn btn-search" type="submit" title="Cari di Database">
              <i class="fas fa-search"></i>
          </button>

        </form>

      {% else %}
        <div class="nav-search-placeholder me-3"></div>
      {% endif %}

      <ul class="navbar-nav ms-auto align-items-center">
        {% if current_user.is_authenticated %}
          
          {# --- BAGIAN KERANJANG (IKON) --- #}
          {% if current_user.role != 'admin' %}
            <li class="nav-item me-3">
              <a class="nav-link position-relative" href="{{ url_for('cart.view_cart') }}" title="Lihat Keranjang">
                <i class="fas fa-shopping-cart fs-5"></i>
                {% if cart_count and cart_count > 0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger border border-light" 
                        style="font-size: 0.65rem; padding: 0.35em 0.5em;">
                    {{ cart_count }}
                    <span class="visually-hidden">item</span>
                  </span>
                {% endif %}
              </a>
            </li>
          {% endif %}
          {# ------------------------------ #}

          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
              <img src="{{ url_for('static', filename='uploads/profile_pics/' + (current_user.image_file or 'default.jpg')) }}"
                   class="rounded-circle" width="25" height="25" style="object-fit: cover;">
              Halo, {{ current_user.username }}
            </a>
            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow">
              <li><a class="dropdown-item" href="{{ url_for('account.profile') }}">Akun Saya</a></li>
              {% if current_user.role != 'admin' %}
                <li><a class="dropdown-item" href="{{ url_for('booking.history') }}">Riwayat</a></li>
              {% endif %}
              {% if current_user.role == 'staff' %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('staff.dashboard') }}">Dashboard Staff</a></li>
              {% endif %}
              {% if current_user.role == 'admin' %}
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{{ url_for('admin.dashboard') }}">Dashboard Admin</a></li>
              {% endif %}
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">Keluar</a></li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item nav-item-auth"><a href="{{ url_for('auth.login') }}" class="auth-link">Masuk</a></li>
          <li class="nav-item nav-item-auth"><a href="{{ url_for('auth.register') }}" class="auth-link">Daftar</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

{# ===================== JAVASCRIPT (FILTER PAGE + CLEAR) ===================== #}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById('nav-search-input');
    const btn = document.getElementById('nav-clear-btn');
    
    if (!input || !btn) return;

    // Fungsi reset grid
    function showAllCards() {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => {
            const wrapper = card.closest('.col, [class*="col-"]');
            if (wrapper) wrapper.style.display = '';
            else card.style.display = '';
        });
    }

    // --- 1. LOGIC CLEAR BUTTON ---
    function updateClear() {
      if (input.value && input.value.trim().length > 0) {
        btn.style.display = 'block';
      } else {
        btn.style.display = 'none';
        showAllCards();
      }
    }
    updateClear();
    
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      input.value = ''; 
      updateClear();
      input.focus();
    });

    // --- 2. LOGIC FILTER HALAMAN (Grid Filter) ---
    input.addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      updateClear();

      const cards = document.querySelectorAll('.card');
      
      if (cards.length > 0) {
          cards.forEach(card => {
             const text = card.textContent.toLowerCase();
             const shouldShow = (query === '' || text.includes(query));
             
             // Cari pembungkus kolom untuk di-hide/show
             const wrapper = card.closest('.col, [class*="col-"]');

             if (wrapper) wrapper.style.display = shouldShow ? '' : 'none';
             else card.style.display = shouldShow ? '' : 'none';
          });
      }
    });

    // Handle tombol ESC
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        input.value = '';
        updateClear();
      }
    });
  });
</script>